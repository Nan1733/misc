schemaVersion: '0.3'
description: EC2インスタンスをコピーして起動する。
parameters:
  InstanceId:
    type: AWS::EC2::Instance::Id
    description: (Required) The ID of the EC2 instance to update.
mainSteps:
  - name: getInstanceNameTag
    action: aws:executeAwsApi
    nextStep: stopInstance
    isEnd: false
    inputs:
      Service: ec2
      Api: DescribeTags
      Filters:
        - Name: resource-id
          Values:
            - '{{ InstanceId }}'
        - Name: key
          Values:
            - Name
    outputs:
      - Name: SourceTagName
        Selector: $.Tags[0].Value
        Type: String
  - description: Stops the target EC2 instance.
    name: stopInstance
    action: aws:changeInstanceState
    nextStep: createTempImage
    isCritical: false
    isEnd: false
    onFailure: Abort
    inputs:
      InstanceIds:
        - '{{ InstanceId }}'
      CheckStateOnly: false
      DesiredState: stopped
  - description: Creates an Amazon Machine Image (AMI) backup of the source EC2 instance.
    name: createTempImage
    action: aws:createImage
    nextStep: tagTempImage
    isCritical: true
    isEnd: false
    onFailure: step:startInstanceOnFailure
    inputs:
      InstanceId: '{{ InstanceId }}'
      ImageDescription: AMI Generated by Automation on {{ global:DATE_TIME }} from {{ InstanceId }}.
      NoReboot: false
      ImageName: DuplicateEc2Instance_{{ InstanceId }}_{{ global:DATE_TIME }}
    outputs:
      - Name: BackupImageId
        Selector: $.ImageId
        Type: String
  - name: tagTempImage
    action: aws:createTags
    nextStep: assertTempImage
    isEnd: false
    inputs:
      ResourceType: EC2
      ResourceIds:
        - '{{ createTempImage.BackupImageId }}'
      Tags:
        - Key: Name
          Value: DuplicateEc2Instance-{{ getInstanceNameTag.SourceTagName }}
  - description: Verifies the Amazon Machine Image (AMI) backup of the source EC2 instance is in `available` state.
    name: assertTempImage
    action: aws:waitForAwsResourceProperty
    nextStep: startInstance
    isCritical: true
    isEnd: false
    onFailure: step:startInstanceOnFailure
    inputs:
      Service: ec2
      Api: DescribeImages
      Filters:
        - Name: image-id
          Values:
            - '{{ createTempImage.BackupImageId }}'
      PropertySelector: $.Images[0].State
      DesiredValues:
        - available
  - name: startInstanceOnFailure
    action: aws:changeInstanceState
    isEnd: true
    inputs:
      InstanceIds:
        - '{{ InstanceId }}'
      DesiredState: running
  - name: startInstance
    action: aws:changeInstanceState
    nextStep: LaunchTempInstance
    isEnd: false
    onFailure: step:DeleteTempImage
    inputs:
      InstanceIds:
        - '{{ InstanceId }}'
      DesiredState: running
  - name: LaunchTempInstance
    action: aws:runInstances
    nextStep: Pause
    isEnd: false
    inputs:
      ImageId: '{{ createTempImage.ImageId }}'
      InstanceType: t3.medium
      SubnetId: subnet-06e8d1fed019802b6
      SecurityGroupIds:
        - sgr-0ed217740c2492602
      IamInstanceProfileArn: arn:aws:iam::111122223333:instance-profile/EC2_SSM_Role
  - name: Pause
    action: aws:pause
    nextStep: DeleteTempInstance
    isEnd: false
    inputs: {}
  - name: DeleteTempInstance
    action: aws:changeInstanceState
    nextStep: DeleteTempImage
    isEnd: false
    inputs:
      InstanceIds:
        - '{{ LaunchTempInstance.InstanceIds }}'
      DesiredState: terminated
  - name: DeleteTempImage
    action: aws:deleteImage
    isEnd: true
    inputs:
      ImageId: '{{ createTempImage.BackupImageId }}'
