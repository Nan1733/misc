schemaVersion: '0.3'
description: AMI取得後にENAドライバのアップデートを行う
parameters:
  InstanceId:
    type: AWS::EC2::Instance::Id
    description: (Required) The ID of the EC2 instance to update.
mainSteps:
  - name: getInstanceNameTag
    action: aws:executeAwsApi
    nextStep: stopInstance
    isEnd: false
    inputs:
      Service: ec2
      Api: DescribeTags
      Filters:
        - Name: resource-id
          Values:
            - '{{ InstanceId }}'
        - Name: key
          Values:
            - Name
    outputs:
      - Name: SourceTagName
        Selector: $.Tags[0].Value
        Type: String
  - description: Stops the target EC2 instance.
    name: stopInstance
    action: aws:changeInstanceState
    nextStep: preUpdateBackup
    isCritical: false
    isEnd: false
    onFailure: Abort
    inputs:
      InstanceIds:
        - '{{ InstanceId }}'
      CheckStateOnly: false
      DesiredState: stopped
  - description: Creates an Amazon Machine Image (AMI) backup of the source EC2 instance.
    name: preUpdateBackup
    action: aws:createImage
    nextStep: tagPreUpdateBackup
    isCritical: true
    isEnd: false
    onFailure: step:startInstanceOnFailure
    inputs:
      InstanceId: '{{ InstanceId }}'
      ImageDescription: Pre-update Backup AMI Generated by Automation on {{ global:DATE_TIME }} from {{ InstanceId }}.
      NoReboot: false
      ImageName: UpdateAwsEnaDrivers-Pre-Script-Backup_{{ InstanceId }}_{{ global:DATE_TIME }}
    outputs:
      - Name: BackupImageId
        Selector: $.ImageId
        Type: String
  - name: tagPreUpdateBackup
    action: aws:createTags
    nextStep: assertPreUpdateBackup
    isEnd: false
    inputs:
      ResourceType: EC2
      ResourceIds:
        - '{{ preUpdateBackup.BackupImageId }}'
      Tags:
        - Key: Name
          Value: UpdateAwsEnaDriverWithBackup-{{ getInstanceNameTag.SourceTagName }}
  - description: Verifies the Amazon Machine Image (AMI) backup of the source EC2 instance is in `available` state.
    name: assertPreUpdateBackup
    action: aws:waitForAwsResourceProperty
    nextStep: startInstance
    isCritical: true
    isEnd: false
    onFailure: step:startInstanceOnFailure
    inputs:
      Service: ec2
      Api: DescribeImages
      Filters:
        - Name: image-id
          Values:
            - '{{ preUpdateBackup.BackupImageId }}'
      PropertySelector: $.Images[0].State
      DesiredValues:
        - available
  - name: startInstanceOnFailure
    action: aws:changeInstanceState
    isEnd: true
    inputs:
      InstanceIds:
        - '{{ InstanceId }}'
      DesiredState: running
  - name: startInstance
    action: aws:changeInstanceState
    nextStep: UpdateAwsEnaDriver
    isEnd: false
    inputs:
      InstanceIds:
        - '{{ InstanceId }}'
      DesiredState: running
  - name: UpdateAwsEnaDriver
    action: aws:executeAutomation
    isEnd: true
    inputs:
      DocumentName: UpdateAwsEnaDriver
      RuntimeParameters:
        InstanceId:
          - '{{ InstanceId }}'
